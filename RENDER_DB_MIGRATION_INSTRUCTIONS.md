# Инструкция по миграции базы данных в регион Frankfurt

## Обзор
В настоящее время ваше приложение `electric-service-crm-backend` развернуто в регионе Frankfurt, а база данных `electric-service-crm-db` находится в регионе Oregon. Это несоответствие регионов вызывает проблемы с подключением и задержками. Данная инструкция поможет вам мигрировать базу данных в регион Frankfurt.

## Предварительные требования
- Доступ к панели управления Render (https://dashboard.render.com)
- Права администратора для удаления и создания сервисов

## Шаг 1: Удаление старой базы данных в регионе Oregon

### 1.1 Войдите в панель управления Render
1. Откройте браузер и перейдите по адресу: https://dashboard.render.com
2. Войдите в свою учетную запись, если необходимо

### 1.2 Найдите старую базу данных
1. В левой навигационной панели выберите раздел **"Databases"**
2. Найдите в списке базу данных с именем `electric-service-crm-db`
3. Убедитесь, что она находится в регионе **Oregon (US West)**

### 1.3 Удалите старую базу данных
1. Нажмите на название базы данных `electric-service-crm-db` для открытия её настроек
2. В верхней правой части экрана найдите кнопку с тремя точками (**⋮**) или кнопку **"Settings"**
3. В выпадающем меню выберите **"Delete Service"**
4. Подтвердите удаление, введя имя сервиса `electric-service-crm-db` в диалоговом окне
5. Нажмите кнопку **"Delete"** для окончательного удаления

**Важно:** Удаление базы данных приведет к потере всех данных. Если у вас есть важные данные, которые нужно сохранить, создайте резервную копию перед удалением.

## Шаг 2: Создание новой базы данных в регионе Frankfurt

### 2.1 Начните создание новой базы данных
1. В левой навигационной панели нажмите кнопку **"New +"**
2. В выпадающем меню выберите **"Database"**
3. Выберите тип базы данных **"PostgreSQL"**

### 2.2 Настройте параметры базы данных
1. **Name**: Введите `electric-service-crm-db` (то же имя, что и у удаленной БД)
2. **Region**: Обязательно выберите **Frankfurt** (или **Europe (Frankfurt)**)
3. **Database Name**: Оставьте `electric_service_crm` (по умолчанию)
4. **User**: Оставьте `electric_service_user` (по умолчанию)
5. **Version**: Выберите **PostgreSQL 15** (или последнюю стабильную версию)
6. **Plan**: Для начала выберите **Free** (бесплатный тариф)

### 2.3 Завершите создание
1. Нажмите кнопку **"Create Database"**
2. Дождитесь завершения процесса создания базы данных (это может занять несколько минут)

## Шаг 3: Проверка подключения и переразвертывание приложения

### 3.1 Проверьте настройки приложения
1. В левой навигационной панели выберите раздел **"Services"**
2. Найдите ваше приложение `electric-service-crm-backend`
3. Откройте настройки приложения

### 3.2 Проверьте переменную окружения DATABASE_URL
1. Перейдите на вкладку **"Environment"**
2. Найдите переменную `DATABASE_URL`
3. Убедитесь, что она настроена на использование новой базы данных:
   ```
   fromDatabase:
     name: electric-service-crm-db
     property: connectionString
   ```

### 3.3 Переразверните приложение
1. Нажмите кнопку **"Manual Deploy"** в верхней части экрана
2. Выберите **"Main branch"** (или вашу рабочую ветку)
3. Нажмите **"Deploy"**
4. Дождитесь завершения процесса развертывания

## Шаг 4: Проверка работоспособности

### 4.1 Проверьте статус приложения
1. Убедитесь, что статус приложения изменился на **"Live"**
2. Откройте URL вашего приложения в браузере

### 4.2 Проверьте эндпоинт health check
1. Откройте в браузере: `https://electric-service-crm-backend.onrender.com/api/auth/health`
2. Вы должны увидеть ответ в формате JSON:
   ```json
   {
     "status": "OK",
     "message": "Сервер аутентификации работает нормально",
     "timestamp": "2024-02-17T08:30:00.000Z",
     "environment": "production"
   }
   ```

### 4.3 Проверьте работу фронтенда
1. Откройте основную страницу приложения: `https://electric-service-crm-backend.onrender.com`
2. Убедитесь, что фронтенд корректно отображается без ошибок

## Возможные проблемы и их решения

### Проблема: Ошибка подключения к базе данных
**Решение:**
1. Проверьте, что база данных создана в регионе Frankfurt
2. Убедитесь, что переменная `DATABASE_URL` правильно настроена
3. Проверьте логи приложения на наличие ошибок подключения

### Проблема: Приложение не запускается после переразвертывания
**Решение:**
1. Проверьте логи сборки на наличие ошибок
2. Убедитесь, что все зависимости установлены корректно
3. Проверьте, что команда сборки в `render.yaml` выполняется без ошибок

### Проблема: Фронтенд не отображается (ошибка 404)
**Решение:**
1. Проверьте, что директория `client/build` создается во время сборки
2. Убедитесь, что статические файлы правильно обслуживаются в production режиме
3. Проверьте логи на наличие ошибок при сборке фронтенда

## Заключение

После выполнения этих шагов ваше приложение будет работать с базой данных в том же регионе, что и сервер, что обеспечит стабильную работу и минимальную задержку при обращении к базе данных.