# Инструкции по развертыванию CRM-системы на Render

## Подготовка к развертыванию

Все необходимые файлы уже настроены для развертывания на платформе Render. Вот что было сделано:

1. **render.yaml** - настроен для автоматического развертывания:
   - Указаны правильные пути для сборки и запуска
   - Добавлены все необходимые переменные окружения
   - Настроена база данных PostgreSQL

2. **.env.example** - содержит все необходимые переменные окружения:
   - Локальные настройки для разработки
   - Настройки для Render (DATABASE_URL, RENDER_EXTERNAL_URL и др.)

3. **package.json** - все зависимости корректно определены:
   - Нет конфликтов версий
   - Указаны необходимые скрипты для сборки

4. **server/config/database.js** - обновлен для поддержки:
   - Локальной разработки (через отдельные параметры)
   - Развертывания на Render (через DATABASE_URL)

5. Удалены временные и отладочные файлы (server/index.js.backup)

## Развертывание на Render

### Шаг 1: Создание репозитория на GitHub

1. Если у вас еще нет репозитория для этого проекта, создайте его на GitHub.
2. Скопируйте URL вашего репозитория (например: `https://github.com/username/electric-service-crm.git`)

### Шаг 2: Инициализация Git и коммит изменений

Откройте терминал в корневой директории проекта (`CRM_VIPAUTO`) и выполните следующие команды:

```bash
# Инициализация Git (если еще не инициализирован)
git init

# Добавление всех файлов в индекс
git add .

# Создание коммита
git commit -m "Готово к развертыванию на Render: исправлены маршруты и настройки"
```

### Шаг 3: Подключение к удаленному репозиторию и отправка изменений

```bash
# Подключение к удаленному репозиторию (замените URL на свой)
git remote add origin https://github.com/username/electric-service-crm.git

# Отправка изменений на GitHub
git push -u origin main
```

Если вы используете другую ветку (например, `master`), замените `main` на название вашей ветки.

### Шаг 4: Развертывание на Render

1. Зарегистрируйтесь на [Render](https://render.com/) или войдите в свой аккаунт.
2. Нажмите "New +" и выберите "Web Service".
3. Выберите "Build and deploy from a Git repository".
4. Подключите свой GitHub-аккаунт и выберите репозиторий с вашим проектом.
5. Render автоматически определит тип сервиса (Node.js) и предложит настройки.
6. Убедитесь, что выбраны следующие настройки:
   - Name: `electric-service-crm` (или любое другое имя)
   - Region: Frankfurt (или ближайший к вам)
   - Branch: `main` (или ваша ветка)
   - Runtime: Node
   - Build Command: `npm install && cd client && npm install && npm run build`
   - Start Command: `node server/index.js`
   - Instance Type: Free (или любой другой по вашему выбору)

7. Нажмите "Create Web Service".

### Шаг 5: Создание базы данных

1. После создания веб-сервиса, перейдите в раздел "Databases".
2. Нажмите "New +" и выберите "PostgreSQL".
3. Настройте базу данных:
   - Name: `electric-service-crm-db` (или любое другое имя)
   - User: `electric_service_user` (или любой другой)
   - Database Name: `electric_service_crm` (или любое другое)
   - Region: Frankfurt (тот же, что и для веб-сервиса)
   - Plan: Free (или любой другой по вашему выбору)

4. Нажмите "Create Database".

### Шаг 6: Настройка переменных окружения

1. Перейдите к вашему веб-сервису на Render.
2. Перейдите на вкладку "Environment".
3. Убедитесь, что автоматически добавлены следующие переменные:
   - `DATABASE_URL` (должна быть автоматически добавлена при создании базы данных)
   - `NODE_ENV` (должна быть установлена в `production`)
   - `PORT` (должна быть установлена в `10000`)
   - `JWT_SECRET` (должна быть автоматически сгенерирована)
   - `JWT_EXPIRES_IN` (должна быть установлена в `7d`)

4. Если какие-то переменные отсутствуют, добавьте их вручную.

### Шаг 7: Проверка развертывания

1. Render автоматически начнет сборку и развертывание вашего приложения.
2. Вы можете отслеживать процесс во вкладке "Logs".
3. После успешного развертывания, вы увидите сообщение "Deploy succeeded".
4. Перейдите по URL вашего приложения (например: `https://electric-service-crm.onrender.com`).
5. Проверьте, что приложение работает корректно:
   - Страница должна загрузиться без ошибок
   - Попробуйте зарегистрироваться и войти в систему
   - Убедитесь, что все функции работают как ожидается

## Возможные проблемы и их решение

### Проблема: Ошибка подключения к базе данных

**Решение:**
1. Убедитесь, что база данных создана и подключена к вашему сервису.
2. Проверьте, что переменная `DATABASE_URL` правильно настроена.
3. Проверьте логи на наличие сообщений об ошибках.

### Проблема: Ошибка сборки

**Решение:**
1. Проверьте логи сборки на наличие сообщений об ошибках.
2. Убедитесь, что все зависимости правильно установлены.
3. Проверьте, что версии Node.js и npm совместимы с вашим проектом.

### Проблема: Приложение работает медленно

**Решение:**
1. Бесплатный тариф Render может быть медленным, особенно при первом запуске.
2. Рассмотрите возможность обновления до платного тарифа для лучшей производительности.

### Проблема: Ошибки CORS

**Решение:**
1. Убедитесь, что в настройках CORS разрешены запросы с вашего домена.
2. Проверьте, что в клиентской части приложения правильно указан URL API.

## Обновление приложения

Для обновления приложения на Render:

1. Внесите необходимые изменения в код.
2. Закоммитьте изменения:
   ```bash
   git add .
   git commit -m "Описание изменений"
   ```
3. Отправьте изменения в GitHub:
   ```bash
   git push origin main
   ```
4. Render автоматически обнаружит изменения и выполнит повторное развертывание.

## Заключение

Теперь ваша CRM-система готова к работе на платформе Render. Если у вас возникнут какие-либо проблемы или вопросы, обращайтесь к документации Render или к службе поддержки.