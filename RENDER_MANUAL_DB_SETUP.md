# Ручная настройка базы данных и переменной DATABASE_URL в Render

Эта инструкция предназначена для случаев, когда у вас нет опции "Connect" для выбора базы данных при настройке переменной окружения DATABASE_URL в Render.

## Содержание
1. [Создание базы данных в Render](#создание-базы-данных-в-render)
2. [Получение строки подключения](#получение-строки-подключения)
3. [Настройка переменной окружения DATABASE_URL](#настройка-переменной-окружения-database_url)
4. [Формат строки подключения](#формат-строки-подключения)
5. [Проверка подключения](#проверка-подключения)
6. [Решение распространенных проблем](#решение-распространенных-проблем)

## Создание базы данных в Render

Если у вас еще нет базы данных в Render, выполните следующие шаги:

1. Войдите в [панель управления Render](https://dashboard.render.com/).
2. Нажмите кнопку **New +** в верхнем правом углу.
3. Выберите **PostgreSQL** из списка сервисов.
4. Заполните форму создания базы данных:
   - **Name**: `electric-service-crm-db` (или любое другое уникальное имя)
   - **Database Name**: `electric_service_crm` (имя базы данных)
   - **User**: `electric_service_user` (имя пользователя)
   - **Plan**: Выберите тарифный план (для начала можно использовать **Free**)
   - **Region**: Выберите ближайший к вам регион (например, **Frankfurt**)
   - **Version**: Оставьте версию по умолчанию (рекомендуется PostgreSQL 15 или выше)

5. Нажмите **Create Database** и дождитесь завершения создания базы данных.

## Получение строки подключения

После создания базы данных вам нужно получить строку подключения:

1. В панели управления Render перейдите в раздел **Databases**.
2. Выберите вашу базу данных из списка.
3. На странице базы данных найдите раздел **Connection**.
4. В этом разделе вы увидите **External Database URL** - это и есть ваша строка подключения к базе данных.
5. Нажмите кнопку **Copy** чтобы скопировать строку подключения в буфер обмена.

Пример строки подключения:
```
postgresql://electric_service_user:password@db.example.com:5432/electric_service_crm
```

## Настройка переменной окружения DATABASE_URL

Теперь вам нужно настроить переменную окружения DATABASE_URL для вашего приложения:

1. В панели управления Render перейдите в раздел **Services**.
2. Выберите ваше приложение (бэкенд) из списка.
3. Перейдите на вкладку **Environment**.
4. Нажмите **Add Environment Variable**.
5. В поле **Key** введите: `DATABASE_URL`
6. В поле **Value** вставьте скопированную ранее строку подключения.
7. Нажмите **Save**.

## Формат строки подключения

Правильный формат строки подключения к PostgreSQL выглядит следующим образом:

```
postgresql://[username]:[password]@[host]:[port]/[database_name]
```

Где:
- `username` - имя пользователя базы данных
- `password` - пароль пользователя
- `host` - хост базы данных
- `port` - порт (обычно 5432 для PostgreSQL)
- `database_name` - имя базы данных

Пример для нашего проекта:
```
postgresql://electric_service_user:your_password_here@your-db-host.compute-1.amazonaws.com:5432/electric_service_crm
```

## Проверка подключения

После настройки переменной окружения DATABASE_URL, вам нужно проверить подключение к базе данных:

1. Перейдите на страницу вашего сервиса в Render.
2. Нажмите **Manual Deploy** → **Deploy latest commit** или дождитесь автоматического развертывания.
3. После завершения развертывания откройте **Logs** для просмотра логов.
4. В логах вы должны увидеть сообщение: `✅ Подключение к базе данных успешно установлено.`

Если вы видите ошибку подключения, проверьте:
- Правильность строки подключения
- Доступность базы данных
- Права пользователя базы данных

## Решение распространенных проблем

### Проблема: Нет опции "Connect" для выбора базы данных

**Решение:**
Это может произойти, если:
- У вас еще нет созданной базы данных в Render
- База данных находится в другом регионе, чем ваше приложение
- У вас нет прав доступа к базе данных

В этом случае следуйте инструкции выше по созданию базы данных и настройке переменной окружения вручную.

### Проблема: Ошибка аутентификации

**Решение:**
1. Проверьте правильность имени пользователя и пароля в строке подключения.
2. Убедитесь, что пользователь имеет права доступа к базе данных.
3. Если вы изменили пароль, обновите строку подключения.

### Проблема: Ошибка подключения к хосту

**Решение:**
1. Проверьте правильность имени хоста в строке подключения.
2. Убедитесь, что база данных доступна извне (в Render базы данных доступны извне по умолчанию).
3. Проверьте, что ваше приложение и база данных находятся в одном регионе.

### Проблема: Ошибка SSL

**Решение:**
В файле `server/config/database.js` уже настроены параметры SSL для Render:

```javascript
dialectOptions: {
  ssl: {
    require: true,
    rejectUnauthorized: false // Необходимо для Render
  }
}
```

Если вы все равно видите ошибки SSL, убедитесь, что в строке подключения указан протокол `postgresql://`, а не `postgres://`.

### Проблема: База данных не найдена

**Решение:**
1. Проверьте правильность имени базы данных в строке подключения.
2. Убедитесь, что база данных создана и доступна.
3. Если вы используете другую базу данных, обновите имя в строке подключения.

## Дополнительная информация

Для получения дополнительной информации о работе с базами данных в Render, обратитесь к [официальной документации Render](https://render.com/docs/databases).

Если у вас возникли проблемы с подключением, вы можете проверить логи базы данных на странице базы данных в панели управления Render.